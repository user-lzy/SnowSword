#VisualFreeBasic_Form#  Version=5.9.7
Locked=0

[Form]
Name=FrmListView
Help=False
ClassStyle=CS_VREDRAW,CS_HREDRAW,CS_DBLCLKS
ClassName=
WinStyle=WS_CAPTION,WS_SYSMENU,WS_MINIMIZEBOX,WS_MAXIMIZEBOX,WS_CLIPSIBLINGS,WS_CLIPCHILDREN,WS_VISIBLE,WS_EX_WINDOWEDGE,WS_EX_CONTROLPARENT,WS_EX_LEFT,WS_EX_LTRREADING,WS_EX_RIGHTSCROLLBAR,WS_POPUP
Style=3 - 常规窗口
Icon=
Caption=
StartPosition=1 - 屏幕中心
WindowState=0 - 正常
Enabled=True
Repeat=True
Left=0
Top=0
Width=775
Height=538
TopMost=False
Child=False
MdiChild=False
TitleBar=True
SizeBox=False
SysMenu=True
MaximizeBox=True
MinimizeBox=True
Help=False
Hscroll=False
Vscroll=False
MinWidth=0
MinHeight=0
MaxWidth=0
MaxHeight=0
NoActivate=False
MousePass=False
TransPer=0
TransColor=SYS,25
Shadow=0 - 无阴影
BackColor=SYS,15
MousePointer=0 - 默认
Tag=
Tab=True
ToolTip=
ToolTipBalloon=False
AcceptFiles=False

[PopupMenu]
Name=mnuWebConnect
Help=
Index=-1
Menu=刷新FrmListView_mnuWebConnect_mnuRefresh0-10-FrmListView_mnuWebConnect_Step10-10显示全部FrmListView_mnuWebConnect_ViewAll0-10-FrmListView_mnuWebConnect_mnuStep10-10复制FrmListView_mnuWebConnect_mnuCopy0-10{复制单格数据FrmListView_mnuWebConnect_mnuLittleCopyCtrl+C0-10}定位文件位置(资源管理器)FrmListView_mnuWebConnect_mnuLocateFilePath0-10
Left=680
Top=190
Tag=

[PopupMenu]
Name=mnuWindow
Help=
Index=-1
Menu=刷新FrmListView_mnuWindow_mnuRefreshF50-10-FrmListView_mnuWindow_mnuStep10-10显示窗口FrmListView_mnuWindow_mnuShowWindow0-10隐藏窗口FrmListView_mnuWindow_mnuHideWindow0-10最小化窗口FrmListView_mnuWindow_mnuMinWindow0-10最大化窗口FrmListView_mnuWindow_mnuMaxWindow0-10-FrmListView_mnuWindow_mnuStep20-10摧毁窗口FrmListView_mnuWindow_mnnuDestroyWindow0-10冻结窗口FrmListView_mnuWindow_mnuFreezeWindow0-10激活窗口FrmListView_mnuWindow_mnuActiveWindow0-10窗口置顶FrmListView_mnuWindow_mnuWindowTop0-10取消置顶FrmListView_mnuWindow_mnuWindowNoTop0-10-FrmListView_mnuWindow_mnuStep30-10复制FrmListView_mnuWindow_mnuCopy0-10{复制单格数据FrmListView_mnuWindow_mnuLittleCopyCtrl+C0-10}
Left=610
Top=270
Tag=

[PopupMenu]
Name=mnuMemory
Help=
Index=-1
Menu=刷新FrmListView_mnuMemory_mnuRefreshF50-10-FrmListView_mnuMemory_mnuStep10-10查看/编辑内存FrmListView_mnuMemory_mnuEditMemory0-10复制FrmListView_mnuMemory_mnuCopy0-10{复制单格数据FrmListView_mnuMemory_mnuLittleCopyCtrl+C0-10}定位文件位置(资源管理器)FrmListView_mnuMemory_mnuLocateFilePath0-10
Left=560
Top=160
Tag=

[Label]
Name=lblNum
Help=
Index=-1
Style=0 - 无边框
Caption=
Enabled=True
Visible=True
ForeColor=SYS,8
BackColor=SYS,25
Font=微软雅黑,9,0
FontWidth=0
FontAngle=0
TextAlign=0 - 左对齐
Prefix=True
Ellipsis=False
Left=690
Top=490
Width=80
Height=20
Layout=0 - 不锚定
MousePointer=0 - 默认
Tag=
ToolTip=
ToolTipBalloon=False

[PopupMenu]
Name=mnuHandle
Help=
Index=-1
Menu=刷新FrmListView_mnuHandle_mnuRefreshF50-10关闭FrmListView_mnuHandle_mnuCloseHandle0-10-FrmListView_mnuHandle_Step10-10复制FrmListView_mnuHandle_mnuCopy0-10{复制单格数据FrmListView_mnuHandle_mnuLittleCopyCtrl+C0-10}
Left=490
Top=260
Tag=

[TextBox]
Name=TxtFilter1
Help=
Index=-1
Style=3 - 凹边框
TextScrollBars=0 - 无滚动条
Text=
Enabled=True
Visible=True
MaxLength=0
ForeColor=SYS,8
BackColor=SYS,5
Font=微软雅黑,9,0
TextAlign=0 - 左对齐
PasswordChar=
Locked=False
HideSelection=True
Multiline=False
Uppercase=False
Lowercase=False
Number=False
AutoHScroll=True
AutoVScroll=False
Left=0
Top=490
Width=690
Height=20
Layout=0 - 不锚定
MousePointer=0 - 默认
Tag=
Tab=True
ToolTip=
ToolTipBalloon=False
LeftMargin=0
RightMargin=0
AcceptFiles=False

[PopupMenu]
Name=mnuUnlock_File
Help=
Index=-1
Menu=刷新FrmListView_mnuUnlock_FIle_mnuRefreshF50-10关闭句柄FrmListView_mnuUnlock_FIle_mnuCloseHandle0-10强制关闭句柄FrmListView_mnuUnlock_FIle_mnuForceCloseHandle0-10结束进程FrmListView_mnuUnlock_FIle_mnuTerminateProcess0-10-FrmListView_mnuUnlock_File_mnuStep10-10复制FrmListView_mnuUnlock_File_mnuCopy0-10{复制单格数据FrmListView_mnuUnlock_File_mnuLittleCopy0-10}
Left=380
Top=250
Tag=

[PopupMenu]
Name=mnuModule
Help=
Index=-1
Menu=刷新FrmListView_mnuModule_mnuRefreshModuleF50-10卸载模块FrmListView_mnuModule_mnuUnloadModule0-10查看HookFrmListView_mnuModule_mnuViewHook0-10-FrmListView_mnuModule_mnuStep10-10复制FrmListView_mnuModule_mnuCopy0-10{复制单格数据FrmListView_mnuModule_mnuLittleCopyCtrl+C0-10}定位文件位置(资源管理器)FrmListView_mnuModule_mnuLocateFilePath0-10
Left=450
Top=150
Tag=

[PopupMenu]
Name=mnuThread
Help=
Index=-1
Menu=刷新FrmListView_mnuThread_mnuRefreshThreadF50-10-FrmListView_mnuThread_Step10-10结束线程FrmListView_mnuThread_mnuTerminateThread0-10强制结束线程FrmListView_mnuThread_mnuForceKillThread0-10-FrmListView_mnuThread_Step20-10挂起(暂停)线程FrmListView_mnuThread_mnuSuspendThread0-10恢复线程FrmListView_mnuThread_mnuResumeThread0-10-FrmListView_mnuThread_mnuStep30-10复制FrmListView_mnuThread_mnuCopy0-10{复制单格数据FrmListView_mnuThread_mnuLittleCopyCtrl+C0-10}定位文件位置(资源管理器)FrmListView_mnuThread_mnuLocateFilePath0-10
Left=360
Top=150
Tag=

[PopupMenu]
Name=mnuPrivilege
Help=
Index=-1
Menu=刷新FrmListView_mnuPrivilege_mnuRefresh0-10
Left=390
Top=350
Tag=

[ListView]
Name=ListView
Help=
Index=-1
Style=1 - 报表视图
BStyle=3 - 凹边框
Theme=False
ImageNormalS=无图像列表控件
ImageSmallS=无图像列表控件
SingleSel=False
ShowSel=True
Sort=0 - 不排序
SortColumn=True
NoScroll=False
AutoArrange=False
EditLabels=False
OwnerData=False
AlignTop=False
AlignLeft=False
OwnDraw=False
ColumnHeader=True
ColumnEditor=
NoSortHeader=False
BorderSelect=False
Check=False
FlatScrollBars=True
FullRowSelect=True
GridLines=True
HeaderDragDrop=False
InfoTip=False
LabelTip=False
MultiWorkAreas=False
OneClickActivate=False
Regional=False
SimpleSelect=False
SubItemImages=False
TrackSelect=False
TwoClickActivate=False
UnderlineCold=False
UnderlineHot=False
Enabled=True
Visible=True
ForeColor=SYS,8
BackColor=SYS,5
TextBkColor=SYS,5
Font=微软雅黑,9,0
Left=0
Top=0
Width=770
Height=490
Layout=0 - 不锚定
MousePointer=0 - 默认
Tag=
Tab=True
ToolTip=
ToolTipBalloon=False
AcceptFiles=False


[AllCode]
'这是标准的工程模版，你也可做自己的模版。
'写好工程，复制全部文件到VFB软件文件夹里【template】里即可，子文件夹名为 VFB新建工程里显示的名称
'快去打造属于你自己的工程模版吧。
Type DO_SOMETHING
    ProcessId As DWORD
    TheContext As PVOID
End Type

Dim Shared CurrentPID As DWORD
Dim Shared CurrentProcessName As StringW

'Dim Shared uData As Integer
'Dim Shared OriginalType As Integer
'[FrmListView]事件 : 窗口完全显示后。
'hWndForm  当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
'UserData  来自显示窗口最后1个参数，例： Form2.Show(父窗口句柄,模式,UserData)
Sub FrmListView_Shown(hWndForm As hWnd, UserData As Integer)
    CurrentInformation.hListView = Me.hWnd
    CurrentInformation.intType = UserData
    'Print "Type:" & UserData
    InitDataNode ListView
    Me.hWndForm = hWndForm 'ListView.hWndForm = hWndForm
    'CurrentInformation = *Cast(CURRENT_INFORMATION Ptr, UserData)
    'Dim pCurrentPID As DWORD Ptr = CPtr(DWORD Ptr, CurrentInformation.pSomeThing)
    CurrentPID = CurrentInformation.ProcessId
    CurrentProcessName = GetNameByPath(GetProcessPath(CurrentPID))
    lblNum.Caption = "正在获取..."
    'Me.SIZE 1100,720
    InitializeListView ListView, FrmMain.mCtrlTreeList1,  FrmMain.TreeView'注意,别莫名其妙炸了
    Select Case CurrentInformation.intType
        Case Module
            GetModuleList CurrentPID, ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case Thread
            GetThreadList CurrentPID, ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case KernelThread
            GetKernelThreadList ListView
        Case Windows
            GetWindowList CurrentPID, ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case WindowTimer
            GetProcessTimerList CurrentPID, ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case Handles
            GetHandleList CurrentPID, ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
            'Print "1"'下面的Print和SetListViewData在执行此次Case后均不会被执行
            'Print "2"
        Case Memory
            GetMemoryBlockList CurrentPID,ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case WebConnect
            GetWebConnectList CurrentPID, ListView, True
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case Privilege
            GetProcessPrivilegeList CurrentPID, ListView
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case Hook
            If CurrentInformation.CurrentModule.ModuleHandle = NULL Then
                'GetProcessHookList 51144, ListView
                'Print "CurrentPID:" & CurrentPID
                GetProcessHookList CurrentPID, ListView
            Else
                'Print CurrentPID & " " & CurrentInformation.CurrentModule.ModuleName & " 0x" & WHex(CurrentInformation.CurrentModule.ModuleHandle)
                'GetModuleHookList 51144, "kernelbase.dll", &H7FFBC9B40000, ListView
                GetModuleHookList CurrentPID, CurrentInformation.CurrentModule.ModuleName, CurrentInformation.CurrentModule.ModuleHandle, ListView
            End If
            Me.Caption = "[" & CurrentProcessName & " " & CurrentPID & "]"
        Case UnlockTheFile
            Unlock_File ListView', FilePathByUnlock
            Me.Caption = "文件占用查看小工具"
            'Print "lvwHandle.ItemCount:" & ListView.ItemCount
        Case IOFunction
            If CurrentInformation.CurrentDriver.DriverObject <> 0 Then GetDriverIOFunctionList ListView, CurrentInformation.CurrentDriver.DriverObject
            Me.Caption = "[" & CurrentInformation.CurrentDriver.DriverName & "]"
    End Select
    'Print "3"
    SetListViewData ListView
    If lblNum.Caption <> "" Then
        lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
    Else
        lblNum.Caption = "数量:" & WStr(ListView.ItemCount)
    End If
    'Print "4"
End Sub

'[FrmListView.ListView]事件 : 鼠标右键单击
'hWndForm    当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
'hWndControl 当前控件的句柄(也是窗口句柄，如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 )
'xPos yPos   当前鼠标位置，相对于屏幕。就是屏幕坐标。
Sub FrmListView_ListView_WM_ContextMenu(hWndForm As hWnd, hWndControl As hWnd, xPos As Long, yPos As Long)
    CurrentPos.x = xPos
    CurrentPos.y = yPos
    ScreenToClient hWndControl, @CurrentPos   
    Select Case CurrentInformation.intType
        Case Module
            mnuModule.hWndForm = hWndForm
            PopupMenu hWndForm,mnuModule.HMENU
        Case Thread, KernelThread
            mnuThread.hWndForm = hWndForm
            PopupMenu hWndForm, mnuThread.HMENU
        Case Memory
            mnuMemory.hWndForm = hWndForm
            PopupMenu hWndForm, mnuMemory.HMENU
        Case WebConnect
            mnuWebConnect.hWndForm = hWndForm
            PopupMenu hWndForm, mnuWebConnect.HMENU
        Case Windows
            mnuWindow.hWndForm = hWndForm
            PopupMenu hWndForm, mnuWindow.HMENU
        Case Handles
            mnuHandle.hWndForm = hWndForm
            PopupMenu hWndForm, mnuHandle.HMENU
        Case UnlockTheFile
            mnuUnlock_FIle.hWndForm = hWndForm
            PopupMenu hWndForm,mnuUnlock_FIle.HMENU
    End Select
End Sub

'[FrmListView.mnuThread]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuThread_WM_Command(hWndForm As hWnd,wID As ULong)
    Select Case wID
        Case FrmListView_mnuThread_mnuRefreshThread ' 刷新线程
            lblNum.Caption = "正在刷新..."
            ListView.DeleteAllItems
            'SetListViewData ListView ' 清空
            GetThreadList CurrentPID, ListView
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
        Case FrmListView_mnuThread_mnuTerminateThread ' 结束线程
            For i As Integer = ListView.ItemCount - 1 To 0 Step -1
                If IsListViewItemSelected(ListView, i) Then
                    If KillThread(ValULng(ListView.GetItemText(i, 0))) Then DeleteItemEx ListView, i
                End If
            Next
            'SetListViewData ListView
        Case FrmListView_mnuThread_mnuForceKillThread ' 强制结束线程
            For i As Integer = ListView.ItemCount - 1 To 0 Step -1
                If IsListViewItemSelected(ListView, i) Then
                    Print "TID:" & Cast(HANDLE, ValULng(ListView.GetItemText(i, 0)))
                    If ForceKillThread(Cast(HANDLE, ValULng(ListView.GetItemText(i, 0)))) Then DeleteItemEx ListView, i
                End If
            Next
        Case FrmListView_mnuThread_mnuSuspendThread ' 挂起线程
            For i As Integer = 0 To ListView.ItemCount - 1
                If IsListViewItemSelected(ListView, i) Then MySuspendThread ValULng(ListView.GetItemText(i, 0))
            Next
        Case FrmListView_mnuThread_mnuResumeThread ' 恢复线程
            For i As Integer = 0 To ListView.ItemCount - 1
                If IsListViewItemSelected(ListView, i) Then MyResumeThread ValULng(ListView.GetItemText(i, 0))
            Next
        Case FrmListView_mnuThread_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If
        Case FrmListView_mnuThread_mnuLocateFilePath ' 定位文件位置(资源管理器)
            Dim lpFilePath As StringW = ListView.GetItemText(ListView.SelectedItem, 6)
            If Not LocateFilePathByExplorer(lpFilePath) Then AfxMsg "定位失败!", "提示"
    End Select
End Sub

'[FrmListView.mnuModule]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuModule_WM_Command(hWndForm As hWnd,wID As ULong)
    Select Case wID
        Case FrmListView_mnuModule_mnuRefreshModule ' 刷新
            lblNum.Caption = "正在刷新..."
            ListView.DeleteAllItems
            GetModuleList CurrentPID, ListView
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
        Case FrmListView_mnuModule_mnuUnloadModule ' 卸载模块
            If UnloadModule(CurrentPID, Cast(HMODULE, Cast(Integer, ValLng("&H" & RightW(ListView.GetItemText(ListView.SelectedItem, 2), Len(ListView.GetItemText(ListView.SelectedItem, 2)) - 2))))) Then
                AfxMsg "卸载成功!"
                DeleteItemEx ListView, ListView.SelectedItem
            Else
                AfxMsg "卸载失败!是否强制卸载?"
            End If
        Case FrmListView_mnuModule_mnuViewHook ' 查看Hook
            CurrentInformation.CurrentModule.ModuleName = ListView.GetItemText(ListView.SelectedItem, 1)
            CurrentInformation.CurrentModule.ModuleHandle = Cast(Any Ptr, ValULng(FF_Replace(ListView.GetItemText(ListView.SelectedItem, 2), "0x", "&H")))
            FrmListView.Show,, Hook
        Case FrmListView_mnuModule_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If
        Case FrmListView_mnuModule_mnuLocateFilePath ' 定位文件位置(资源管理器)
            Dim lpFilePath As StringW = ListView.GetItemText(ListView.SelectedItem, 4)
            If Not LocateFilePathByExplorer(lpFilePath) Then AfxMsg "定位失败!", "提示"
   End Select
End Sub

'[FrmListView]事件 : 即将关闭窗口，返回非0可阻止关闭
'hWndForm  当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
Function FrmListView_WM_Close(hWndForm As hWnd) As LResult
    'CurrentInformation_Dict.Remove Str(FrmListView.hWnd)
    'CurrentType = OriginalType
    'Print "CurrentType:" & CurrentType & __FUNCTION__
   Function = FALSE ' 返回 TRUE 阻止关闭窗口。
End Function

'[FrmListView]事件 : 活动状态（被激活或失去焦点）
'hWndForm    当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
'fActive     =0 失去焦点 <>0 得到焦点
Sub FrmListView_WM_NcActivate(hWndForm As hWnd, fActive As Long)
    Dim CurrentIndex As Integer = GetIndexByListViewHwnd(hWndForm)
    Me.hWndForm = hWndForm
    If fActive = 0 Then
        'Print "[FrmListView]失去焦点," & FrmListView.hWnd & "->" & CurrentInformation.intType & " CurrentIndex:" & CurrentIndex
        'CurrentInformationArray(CurrentIndex).hListView = hWndForm
        CurrentInformationArray(CurrentIndex).intType = CurrentInformation.intType
        CurrentInformationArray(CurrentIndex).ProcessId = CurrentPID
        
        CurrentInformationArray(CurrentIndex).CurrentModule.ModuleName = CurrentInformation.CurrentModule.ModuleName
        CurrentInformationArray(CurrentIndex).CurrentModule.ModuleHandle = CurrentInformation.CurrentModule.ModuleHandle
        
        CurrentInformationArray(CurrentIndex).CurrentDriver.DriverBase = CurrentInformation.CurrentDriver.DriverBase
        CurrentInformationArray(CurrentIndex).CurrentDriver.DriverSize = CurrentInformation.CurrentDriver.DriverSize
        CurrentInformationArray(CurrentIndex).CurrentDriver.DriverObject = CurrentInformation.CurrentDriver.DriverObject
        CurrentInformationArray(CurrentIndex).CurrentDriver.DriverName = CurrentInformation.CurrentDriver.DriverName
        CurrentInformationArray(CurrentIndex).CurrentDriver.DriverPath = CurrentInformation.CurrentDriver.DriverPath
    Else
        'Print "[FrmListView]得到焦点," & FrmListView.hWnd & "->" & CurrentInformation.intType & " CurrentIndex:" & CurrentIndex
        If CurrentIndex = -1 Then
            For i As Integer = 0 To UBound(CurrentInformationArray)
                If CurrentInformationArray(i).hListView = NULL Then
                    CurrentIndex = i
                    'Print "[FrmListView]得到焦点后," & FrmListView.hWnd & "->" & CurrentInformation.intType'与FrmMain的初始化同理
                    Exit For
                End If
            Next
            If CurrentIndex = -1 Then
                CurrentIndex = UBound(CurrentInformationArray) + 1
                ReDim Preserve CurrentInformationArray(UBound(CurrentInformationArray) + 5) As CURRENT_INFORMATION ' 开第二个不同FrmListView时崩溃
            End If
            'Print "UBound(CurrentInformationArray):" & UBound(CurrentInformationArray) & " CurrentIndex:" & CurrentIndex
            CurrentInformationArray(CurrentIndex).hListView = hWndForm
        Else
            'memcpy @CurrentInformation, @CurrentInformationArray(CurrentIndex), SizeOf(CurrentInformation)
            CurrentInformation.intType = CurrentInformationArray(CurrentIndex).intType
            CurrentPID = CurrentInformationArray(CurrentIndex).ProcessId
            
            CurrentInformation.CurrentModule.ModuleName = CurrentInformationArray(CurrentIndex).CurrentModule.ModuleName
            CurrentInformation.CurrentModule.ModuleHandle = CurrentInformationArray(CurrentIndex).CurrentModule.ModuleHandle
            
            CurrentInformation.CurrentDriver.DriverBase = CurrentInformationArray(CurrentIndex).CurrentDriver.DriverBase
            CurrentInformation.CurrentDriver.DriverSize = CurrentInformationArray(CurrentIndex).CurrentDriver.DriverSize
            CurrentInformation.CurrentDriver.DriverObject = CurrentInformationArray(CurrentIndex).CurrentDriver.DriverObject
            CurrentInformation.CurrentDriver.DriverName = CurrentInformationArray(CurrentIndex).CurrentDriver.DriverName
            CurrentInformation.CurrentDriver.DriverPath = CurrentInformationArray(CurrentIndex).CurrentDriver.DriverPath
            'Print "[FrmListView]得到焦点后," & FrmListView.hWnd & "->" & CurrentInformation.intType'与FrmMain的初始化同理
        End If
   End If
End Sub

'[FrmListView.mnuUnlock_FIle]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuUnlock_File_WM_Command(hWndForm As hWnd,wID As ULong)
    Select Case wID
        Case FrmListView_mnuUnlock_File_mnuRefresh '刷新列表
            lblNum.Caption = "正在刷新..."
            Unlock_File ListView
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))'WStr(FilterAllItem(ListView))
        Case FrmListView_mnuUnlock_FIle_mnuCloseHandle ' 关闭句柄
            For i As Integer = ListView.ItemCount - 1 To 0 Step -1
                If IsListViewItemSelected(ListView, i) Then
                    If CloseProcessHandle(ValUInt(ListView.GetItemText(i, 1)), Cast(HANDLE, ValULng(FF_Replace(ListView.GetItemText(i, 4), "0x", "&H")))) Then
                        DeleteItemEx ListView, i
                        AfxMsg "关闭句柄成功!", "提示"
                    Else
                        AfxMsg "关闭句柄失败!", "提示"
                    End If
                End If
            Next
            lblNum.Caption = "数量:" & ListView.ItemCount
            'SetListViewData ListView
        Case FrmListView_mnuUnlock_FIle_mnuForceCloseHandle ' 强制关闭句柄
            '&H863
            Dim DoSomething As DO_SOMETHING
            DoSomething.ProcessId = ValULng(ListView.GetItemText(ListView.SelectedItem, 1))
            DoSomething.TheContext = Cast(HANDLE, ValULng(FF_Replace(ListView.GetItemText(ListView.SelectedItem, 4), "0x", "&H")))
            IoControl hDrv, IOCTL_CloseHandle, @DoSomething, SizeOf(DO_SOMETHING)
            If (GetLastError = 0) Then
                AfxMsg "强制关闭句柄成功!", "提示"
                DeleteItemEx ListView, ListView.SelectedItem
            Else
                AfxMsg "强制关闭句柄失败!", "提示"
                Print "[FrmListView_mnuUnlock_FIle_mnuForceCloseHandle]" & WinErrorMsg(GetLastError) & GetLastError
            End If
        Case FrmListView_mnuUnlock_FIle_mnuTerminateProcess ' 结束进程
            KillProcess ValULng(ListView.GetItemText(ListView.SelectedItem, 1))
        Case FrmListView_mnuUnlock_File_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If
   End Select
End Sub

'[FrmListView.TxtFilter1]事件 : 文本已经被修改（修改前用 EN_UPDATE
'hWndForm    当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
'hWndControl 当前控件的句柄(也是窗口句柄，如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 )
Sub FrmListView_TxtFilter1_EN_Change(hWndForm As hWnd, hWndControl As hWnd)
    lblNum.Caption = "正在筛选..."
    SetFilter ListView, TxtFilter1.Text
    lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
End Sub

'[FrmListView.mnuMemory]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuMemory_WM_Command(hWndForm As hWnd,wID As ULong)
   Select Case wID
        Case FrmListView_mnuMemory_mnuRefresh ' 刷新
            lblNum.Caption = "正在刷新..."
            GetMemoryBlockList CurrentPID, ListView
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
        Case FrmListView_mnuMemory_mnuEditMemory ' 查看/编辑内存
            Dim lvinfo As LVHITTESTINFO, Addr As ULONG64
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            Addr = ValULng(ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem))
            FrmMemoryEditor.Show,, Addr
        Case FrmListView_mnuMemory_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If
        Case FrmListView_mnuMemory_mnuLocateFilePath ' 定位文件位置(资源管理器)
            Dim lpFilePath As StringW = ListView.GetItemText(ListView.SelectedItem, 6)
            If Not LocateFilePathByExplorer(lpFilePath) Then AfxMsg "定位失败!", "提示"
   End Select
End Sub

'[FrmListView.mnuHandle]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuHandle_WM_Command(hWndForm As hWnd,wID As ULong)
   Select Case wID
        Case FrmListView_mnuHandle_mnuRefresh ' 刷新
            lblNum.Caption = "正在刷新..."
            GetHandleList CurrentPID, ListView
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
        Case FrmListView_mnuHandle_mnuCloseHandle ' 关闭
            For i As Integer = ListView.ItemCount - 1 To 0 Step -1
                If IsListViewItemSelected(ListView, i) Then
                    CloseProcessHandle ValULng(ListView.GetItemText(i, 1)), Cast(HANDLE, ValULng(ListView.GetItemText(i, 4)))
                    DeleteItemEx ListView, i
                End If
            Next
        Case FrmListView_mnuHandle_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If
   End Select
End Sub

'[FrmListView.mnuWebConnect]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuWebConnect_WM_Command(hWndForm As hWnd,wID As ULong)
   Select Case wID
        Case FrmListView_mnuWebConnect_mnuRefresh ' 刷新
            lblNum.Caption = "正在刷新..."
            GetWebConnectList CurrentPID, ListView, Not GetMenuCheckState(mnuWebConnect, FrmListView_mnuWebConnect_ViewAll)
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
        Case FrmListView_mnuWebConnect_ViewAll ' 显示全部
            lblNum.Caption = "正在刷新..."
            GetWebConnectList CurrentPID, ListView, GetMenuCheckState(mnuWebConnect, FrmListView_mnuWebConnect_ViewAll)
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
            SetMenuCheckState mnuWebConnect, FrmListView_mnuWebConnect_ViewAll, Not GetMenuCheckState(mnuWebConnect, FrmListView_mnuWebConnect_ViewAll)
        Case FrmListView_mnuWebConnect_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If            
    End Select
End Sub
'[FrmListView.mnuWindow]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuWindow_WM_Command(hWndForm As hWnd, wID As ULong)
   Dim hWnd As HWND = Cast(HWND, ValLng(FF_Replace(ListView.GetItemText(ListView.SelectedItem, 0), "0x", "&H")))
   Select Case wID
        Case FrmListView_mnuWindow_mnuRefresh ' 刷新
            lblNum.Caption = "正在刷新..."
            GetWindowList CurrentPID, ListView
            SetListViewData ListView
            lblNum.Caption = "数量:" & WStr(FilterAllItem(ListView))
        Case FrmListView_mnuWindow_mnuShowWindow ' 显示窗口
            NtUserShowWindow(hWnd, SW_SHOW)
        Case FrmListView_mnuWindow_mnuHideWindow ' 隐藏窗口
            NtUserShowWindow(hWnd, SW_HIDE)
        Case FrmListView_mnuWindow_mnuMinWindow ' 最小化窗口
            NtUserShowWindow(hWnd, SW_SHOWMINIMIZED)
        Case FrmListView_mnuWindow_mnuMaxWindow ' 最大化窗口
            NtUserShowWindow(hWnd, SW_SHOWMAXIMIZED)
        Case FrmListView_mnuWindow_mnnuDestroyWindow ' 摧毁窗口
            NtUserDestroyWindow(hWnd)
            DeleteItemEx ListView, ListView.SelectedItem
        Case FrmListView_mnuWindow_mnuFreezeWindow ' 冻结窗口
            EnableWindow hWnd, False
        Case FrmListView_mnuWindow_mnuActiveWindow ' 激活窗口
            EnableWindow hWnd, True
            SwitchToThisWindow hWnd, True
        Case FrmListView_mnuWindow_mnuWindowTop ' 窗口置顶
            SetWindowPos hWnd, HWND_TOPMOST, 0, 0, 0, 0, SWP_NOMOVE Or SWP_NOSIZE
        Case FrmListView_mnuWindow_mnuWindowNoTop ' 取消置顶
            SetWindowPos hWnd, HWND_NOTOPMOST, 0, 0, 0, 0, SWP_NOMOVE Or SWP_NOSIZE
        Case FrmListView_mnuWindow_mnuLittleCopy ' 复制单格数据
            Dim lvinfo As LVHITTESTINFO
            lvinfo.pt.x = CurrentPos.x
            lvinfo.pt.y = CurrentPos.y
            ListView_SubItemHitTest(ListView.hWnd, @lvinfo)
            If (lvinfo.iItem >= 0 AndAlso lvinfo.iItem <= ListView.ItemCount - 1) AndAlso _
            (lvinfo.iSubItem >= 0 AndAlso lvinfo.iSubItem <= ListView.ColumnCount - 1) Then
                CopyDataToClipboard ListView.GetItemText(lvinfo.iItem, lvinfo.iSubItem)
            End If
   End Select
End Sub

'[FrmListView]事件 : 自定义消息（全部消息），在其它事件处理后才轮到本事件。
'hWndForm    当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
'wMsg        消息值，0--&H400 由WIN系统定义，用户自定义是 WM_USER+** 定义。例 PostMessage( 窗口句柄 , Msg , wParam , lParam ) 
'wParam      主消息参数，什么作用，由发送消息者定义
'lParam      副消息参数，什么作用，由发送消息者定义
Function FrmListView_Custom(hWndForm As hWnd, wMsg As UInteger, wParam As wParam, lParam As lParam) As LResult
    Select Case wMsg
        Case WM_NOTIFY
            ' 解析 NMHDR 结构体（lParam 指向它）
            Dim As LPNMHDR pNMHDR = Cast(LPNMHDR, lParam)
            ' 判断：是否来自目标 ListView，且是 NM_CUSTOMDRAW 通知
            If pNMHDR->hwndFrom = ListView.hWnd AndAlso pNMHDR->code = NM_CUSTOMDRAW Then
                Dim As LPNMLVCUSTOMDRAW pLVCD = Cast(LPNMLVCUSTOMDRAW, lParam)
                Dim As LRESULT result = CDRF_DODEFAULT
                Select Case pLVCD->nmcd.dwDrawStage
                    Case CDDS_PREPAINT
                        result = CDRF_NOTIFYITEMDRAW ' 通知项绘制
                    Case CDDS_ITEMPREPAINT
                        Dim Node As ListViewDataNode Ptr = FindListViewHwnd(ListView)
                        If Node <> NULL Then
                            Dim rowIndex As Integer = pLVCD->nmcd.dwItemSpec
                            ' 检查数组边界
                            If rowIndex >= 0 And rowIndex <= UBound(Node->Filter_ItemColor) Then
                                pLVCD->clrTextBk = Node->Filter_ItemColor(rowIndex).BackColor
                                pLVCD->clrText = Node->Filter_ItemColor(rowIndex).ForeColor
                            Else
                                ' 超出边界使用默认颜色
                                pLVCD->clrTextBk = FB_White
                                pLVCD->clrText = FB_Black
                            End If
                        Else
                            pLVCD->clrTextBk = FB_White
                            pLVCD->clrText = FB_Black
                        End If
                        result = CDRF_DODEFAULT
                End Select
                Return result
            End If
    End Select
End Function

'[FrmListView.mnuPrivilege]事件 : 点击了菜单项
'hWndForm 当前窗口的句柄(WIN系统用来识别窗口的一个编号，如果多开本窗口，必须 Me.hWndForm = hWndForm 后才可以执行后续操作本窗口的代码)
''           本控件为功能控件，就是无窗口，无显示，只有功能。如果多开本窗口，必须 Me.控件名.hWndForm = hWndForm 后才可以执行后续操作本控件的代码 
'wID      菜单项命令ID
Sub FrmListView_mnuPrivilege_WM_Command(hWndForm As hWnd,wID As ULong)
   Select Case wID
      Case FrmListView_mnuPrivilege_mnuRefresh ' 刷新

   End Select
End Sub



